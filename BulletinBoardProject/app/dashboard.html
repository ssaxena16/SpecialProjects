<!DOCTYPE html>
<html lang="en" data-textdirection="ltr" class="loading">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta name="description" content="Robust admin is super flexible, powerful, clean &amp; modern responsive bootstrap 4 admin template with unlimited possibilities.">
    <meta name="keywords" content="admin template, robust admin template, dashboard template, flat admin template, responsive admin template, web app">
    <meta name="author" content="PIXINVENT">
    <title>Dashboard 2 - Robust Free Bootstrap Admin Template</title>
    <link rel="apple-touch-icon" sizes="60x60" href="app-assets/images/ico/apple-icon-60.png">
    <link rel="apple-touch-icon" sizes="76x76" href="app-assets/images/ico/apple-icon-76.png">
    <link rel="apple-touch-icon" sizes="120x120" href="app-assets/images/ico/apple-icon-120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="app-assets/images/ico/apple-icon-152.png">
    <link rel="shortcut icon" type="image/x-icon" href="app-assets/images/ico/favicon.ico">
    <link rel="shortcut icon" type="image/png" href="app-assets/images/ico/favicon-32.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <!-- BEGIN VENDOR CSS-->
    <link rel="stylesheet" type="text/css" href="app-assets/css/bootstrap.css">
    <!-- font icons-->
    <link rel="stylesheet" type="text/css" href="app-assets/fonts/icomoon.css">
    <link rel="stylesheet" type="text/css" href="app-assets/fonts/flag-icon-css/css/flag-icon.min.css">
    <link rel="stylesheet" type="text/css" href="app-assets/vendors/css/extensions/pace.css">
    <!-- END VENDOR CSS-->
    <!-- BEGIN ROBUST CSS-->
    <link rel="stylesheet" type="text/css" href="app-assets/css/bootstrap-extended.css">
    <link rel="stylesheet" type="text/css" href="app-assets/css/app.css">
    <link rel="stylesheet" type="text/css" href="app-assets/css/colors.css">
    <!-- END ROBUST CSS-->
    <!-- BEGIN Page Level CSS-->
    <link rel="stylesheet" type="text/css" href="app-assets/css/core/menu/menu-types/vertical-menu.css">
    <link rel="stylesheet" type="text/css" href="app-assets/css/core/menu/menu-types/vertical-overlay-menu.css">
    <link rel="stylesheet" type="text/css" href="app-assets/css/core/colors/palette-gradient.css">
    <!-- END Page Level CSS-->
    <!-- BEGIN Custom CSS-->
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">
    <!-- END Custom CSS-->
  </head>
  <body data-open="click" data-menu="vertical-menu" data-col="2-columns" class="vertical-layout vertical-menu 2-columns  fixed-navbar">

    <!-- navbar-fixed-top-->
    <nav class="header-navbar navbar navbar-with-menu navbar-fixed-top navbar-semi-dark navbar-shadow">
      <div class="navbar-wrapper">
        <div class="navbar-header">
          <ul class="nav navbar-nav">
            <li class="nav-item mobile-menu hidden-md-up float-xs-left"><a class="nav-link nav-menu-main menu-toggle hidden-xs"><i class="icon-menu5 font-large-1"></i></a></li>
            <li class="nav-item"><a href="index.html" class="navbar-brand nav-link"><img alt="branding logo" src="app-assets/images/logo/robust-logo-light.png" data-expand="app-assets/images/logo/robust-logo-light.png" data-collapse="app-assets/images/logo/robust-logo-small.png" class="brand-logo"></a></li>

          </ul>
        </div>
        <div class="navbar-container content container-fluid">
          <div id="navbar-mobile" class="collapse navbar-toggleable-sm">
            <ul class="nav navbar-nav">
              <li class="nav-item hidden-sm-down">
                  <a onclick="openModal('new-requirement-form')"
                  class="btn btn-success upgrade-to-pro">Add new requirement</a>
              </li>
            </ul>
            <ul class="nav navbar-nav float-xs-right">
              <li class="dropdown dropdown-notification nav-item"><a href="#" data-toggle="dropdown" class="nav-link nav-link-label"><i class="ficon icon-bell4"></i>
                <span class="tag tag-pill tag-default tag-danger tag-default tag-up" id="unread-notifications-count">0</span></a>
                <ul class="dropdown-menu dropdown-menu-media dropdown-menu-right" id="unread-notifications-list">
                </ul>
              </li>

              <li class="dropdown dropdown-user nav-item">
                <a href="#" data-toggle="dropdown" class="dropdown-toggle nav-link dropdown-user-link">
                  <span class="avatar avatar-online">
                    <img src="app-assets/images/portrait/small/avatar-s-1.png" alt="avatar"><i></i>
                  </span>
                  <span class="user-name">John Doe</span>
                </a>
                <div class="dropdown-menu dropdown-menu-right">
                  <a href="javascript:logout()" class="dropdown-item"><i class="icon-power3"></i> Logout</a>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- ////////////////////////////////////////////////////////////////////////////-->


    <div class="app-content content container-fluid" style="margin-left:0px;">
      <div class="content-wrapper">
        <div class="content-header row">
        </div>
        <div class="content-body">
          <!-- Requirements -->
          <div class="row">
              <div class="col-xl-12 col-lg-12">
                  <div class="card">
                      <div class="card-header">
                          <h4 class="card-title">Total Requirements</h4>
                          <a class="heading-elements-toggle"><i class="icon-ellipsis font-medium-3"></i></a>
                          <div class="heading-elements">
                              <ul class="list-inline mb-0">
                                  <li><a data-action="reload" onclick="javascript:getUserData();"><i class="icon-reload"></i></a></li>
                              </ul>
                          </div>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive" id="table-responsive">
                              <table class="table table-hover mb-0">
                                  <thead>
                                      <tr>
                                          <th>Owner</th>
                                          <th>Requirement</th>
                                          <th>Description</th>
                                          <th>Priority</th>
                                          <th></th>
                                      </tr>
                                  </thead>
                                  <tbody id="user-requirements">
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          <!--/ Requirements Ends -->

          <!-- Notifications -->
          <div class="row">
              <div class="col-xl-12 col-lg-12">
                  <div class="card">
                      <div class="card-header">
                          <h4 class="card-title">Other Users Requirements</h4>
                          <a class="heading-elements-toggle"><i class="icon-ellipsis font-medium-3"></i></a>
                          <div class="heading-elements">
                              <ul class="list-inline mb-0">
                                  <li><a data-action="reload" onclick="javascript:getNotifications();"><i class="icon-reload"></i></a></li>
                              </ul>
                          </div>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive" id="table-responsive-1">
                              <table class="table table-hover mb-0">
                                  <thead>
                                      <tr>
                                          <th>Owner</th>
                                          <th>Requirement</th>
                                          <th>Description</th>
                                          <th>Priority</th>
                                          <th></th>
                                      </tr>
                                  </thead>
                                  <tbody id="user-notifications">
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          <!--/ Notifications Ends -->
        </div>
      </div>
    </div>


    <!-- Modal -->
    <div class="modal fade text-xs-left" id="new-requirement-form" tabindex="-1" role="dialog" aria-labelledby="myModalLabel33" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" id= "close_icon" class="close" data-dismiss="modal" aria-label="Close" onclick="closeModal('new-requirement-form')">
              <span aria-hidden="true">&times;</span>
            </button>
            <label class="modal-title text-text-bold-600" id="myModalLabel33">Add new requirement</label>
          </div>
          <form action="#">
              <div class="modal-body">
            <label>Requirement Type: </label>
            <div class="form-group">
              <input type="text" placeholder="Requirement Type(Car pool, Room rent etc...)" class="form-control" id="requirment-type">
            </div>

            <label>Description: </label>
            <div class="form-group">
              <textarea id="description" rows="5" class="form-control square" name="description" placeholder="Description"></textarea>
            </div>

            <label>Priority: </label>
            <div class="form-group">
              <div class="dropdown">
                <button class="btn btn-secondary btn-block dropdown-toggle" id="priorityDropdown" type="button" data-toggle="dropdown"
                style="width: 100px;" aria-expanded="false" value="None">None
                <span class="caret"></span></button>
                <ul class="dropdown-menu" style="padding: 10px;">
                  <li><a href="javascript:selectPriority('None');"><span class="tag tag-default">None</span></a></li>
                  <li><a href="javascript:selectPriority('Low');"><span class="tag tag-success">Low</span></a></li>
                  <li><a href="javascript:selectPriority('Medium');"><span class="tag tag-warning">Medium</span></a></li>
                  <li><a href="javascript:selectPriority('High');"><span class="tag tag-danger">High</span></a></li>
                </ul>
              </div>
            </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-warning mr-1" onclick="resetForm();">
									<i class="icon-cross2"></i> Cancel
							</button>
              <button type="button" class="btn btn-primary" onclick="saveRequirement()">
									<i class="icon-check2"></i> Save
							</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade text-xs-left" id="reply-comment-form" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
      <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeModal('reply-comment-form')">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="requirment-title"></h4>
        </div>
        <div class="modal-body" id="requirment-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning mr-1" onclick="closeModal('reply-comment-form')">
  									<i class="icon-cross2"></i> Cancel
  				</button>
          <button type="submit" class="btn btn-primary" onclick="saveComment()">
  									<i class="icon-check2"></i> Save
  				</button>
        </div>
      </div>
      </div>
    </div>

    <!-- ////////////////////////////////////////////////////////////////////////////-->

    <style>
      .btn-class{
        padding: 0.35em 0.4em !important;
        font-size: 85% !important;
        font-weight: 600 !important;
        line-height: 1 !important;
      }
    </style>
    <!-- BEGIN VENDOR JS-->
    <script src="app-assets/js/core/libraries/jquery.min.js" type="text/javascript"></script>
    <script>
      var userList = [];
      var currentUser = JSON.parse(localStorage.getItem("userSession"));
      if(typeof currentUser === 'undefined' || currentUser ===  null)
      {
        window.location = window.location.hostname + "/BulletinBoardProject/app/login.html";
      }
      var notificationCount = 0;
      $('.user-name').html(currentUser.username);
      function selectPriority(priority){
        $('#priorityDropdown').val(priority);
        $('#priorityDropdown').html(priority + '<span class="caret"></span>')
      }

      function resetForm(){
        $('#requirment-type').val('');
        $('#description').val('');
        selectPriority('None');
        closeModal('new-requirement-form');
      }

      function saveRequirement(){
        var requirement = {
            id: 0,
            title: $('#requirment-type').val(),
            description: $('#description').val(),
            time: new Date(),
            priority: $('#priorityDropdown').val()
        };

        if(typeof currentUser.requirements === 'undefined')
        {
          currentUser.requirements = [];
          requirement.id = 1;
        }
        else
          requirement.id = currentUser.requirements.length + 1;

        currentUser.requirements.push(requirement);
        localStorage.setItem("userSession", JSON.stringify(currentUser));
        $.ajax({
          url: "http://localhost:3000/users/" + currentUser.id ,
          type: 'PUT',
          data: JSON.stringify(currentUser),
          contentType: "application/json",
          success: function(data) {
            addNotification(requirement.id, requirement.priority,
              currentUser.id, currentUser.username, $('#requirment-type').val(),$('#description').val());
          },
        });
      }

      function addNotification(requirementId, priority, userId, userName, title, description){
        var notification = {
          requirementId: requirementId,
          time: new Date(),
          priority: priority,
          userId: userId,
          username: userName,
          title: title,
          description: description,
          usersRead: []
        };
        $.post("http://localhost:3000/notifications", notification)
        .done(function( data ) {
          getUserData();

          closeModal('new-requirement-form');
        });
      }


    </script>
    <script>
      getUserData();
      getNotifications();
      getAllUser();

      function getAllUser(){
        $.getJSON("http://localhost:3000/users", function(usersData){
          if(usersData !== null){
             userList = usersData;
          }
        });
      }

      function getUserData(){
        $.getJSON("http://localhost:3000/users/", {username: currentUser.username}, function(userData){
          if(userData !== null){
            var user = userData[0];
            console.log(userData)
            if(typeof user.requirements !== 'undefined'){
                var userRequirments = '';
                for(i=0; i< user.requirements.length; i++){
                  console.log(user.requirements[i]);
                  userRequirments += '<tr>'
                            + '<td class="text-truncate">'
                              + '<span class="avatar avatar-xs"><img src="app-assets/images/portrait/small/avatar-s-4.png" alt="avatar"></span> '
                              + currentUser.username
                            + '</td>'
                            + '<td class="text-truncate">'
                              + user.requirements[i].title
                            + '</td>'
                            + '<td class="text-truncate">'
                              + user.requirements[i].description
                            + '</td>'
                            + '<td class="text-truncate">'
                              + getPriorityHtmlBlock(user.requirements[i].priority)
                            + '</td>'
                            + '<td><button type="button" class="btn btn-info btn-class">Comment</button></td>'
                            + '</tr>'
                }
                $('#user-requirements').html(userRequirments);

            }
            else {
              hmtl = '<div class="card-block"><p class="m-0" id=blank-requirements>No requirements posted</p></div>';
              if($('#blank-requirements').length == 0)
                $('#table-responsive').after(hmtl);
            }
          }
        });
      }

      function getNotifications(){
        $.getJSON("http://localhost:3000/notifications", function(otherPosts){
          if(typeof otherPosts !== 'undefined' && otherPosts !== null && otherPosts.length > 0){
            var otherNotifications = $.grep(otherPosts, function( n, i ) {
                    return n.userId != currentUser.id;
            });

            var notifications = otherNotifications.sort(function compare(a, b) {
                  var dateA = new Date(a.time);
                  var dateB = new Date(b.time);
                  return dateA>dateB ? -1 : dateA<dateB ? 1 : 0;
                });

            if(notifications.length > 0){
              var userNotifications = '';
              var unreadNotifications = '';

              for(i= 0; i< notifications.length; i++){
                  if(typeof notifications[i].userread !== 'undefined') {
                    console.log(notifications[i].userread);
                    if(notifications[i].userread.length > 0 && !notifications[i].userread.includes(currentUser.id)) {
                      notificationCount++;
                      unreadNotifications += getNotificationBlock(notifications);
                    }
                  }
                  else{
                    notificationCount++;
                    unreadNotifications += getNotificationBlock(notifications);
                  }

                    userNotifications += '<tr>'
                              + '<td class="text-truncate">'
                                + '<span class="avatar avatar-xs"><img src="app-assets/images/portrait/small/avatar-s-4.png" alt="avatar"></span> '
                                + notifications[i].username
                              + '</td>'
                              + '<td class="text-truncate">'
                                + notifications[i].title
                              + '</td>'
                              + '<td class="text-truncate">'
                                + notifications[i].description
                              + '</td>'
                              + '<td class="text-truncate">'
                                + getPriorityHtmlBlock(notifications[i].priority)
                              + '</td>'
                              + '<td><button type="button" class="btn btn-primary btn-class" '
                              + 'onclick=\'replyToRequirement('+JSON.stringify(notifications[i])+')\'>Reply</button></td>'
                              + '</tr>'
              }
              unreadNotifications = '<li class="dropdown-menu-header">'
                    	+ '<h6 class="dropdown-header m-0"><span class="grey darken-2">Notifications</span>'
                    	+ '<span class="notification-tag tag tag-default tag-danger float-xs-right m-0">'
                    	+ notificationCount + ' New</span></h6>'
                      + '</li>'
                      + unreadNotifications;
              $('#unread-notifications-count').html(notificationCount);
              $('#unread-notifications-list').html(unreadNotifications);
              $('#user-notifications').html(userNotifications);
            }
            else {
              hmtl = '<div class="card-block"><p class="m-0" id="blank-notifications">No other requirements posted</p></div>';
              if($('#blank-notifications').length == 0)
                $('#table-responsive-1').after(hmtl);
            }
          }
          else {
            hmtl = '<div class="card-block"><p class="m-0" id="blank-notifications">No other requirements posted</p></div>';
            if($('#blank-notifications').length == 0)
              $('#table-responsive-1').after(hmtl);
          }
        });
      }

      function getPriorityHtmlBlock(type){
        switch(type){
          case "None": return '<span class="tag tag-default">None</span>';
          case "Low": return '<span class="tag tag-success">Low</span>';
          case "Medium": return '<span class="tag tag-warning">Medium</span>';
          case "High": return '<span class="tag tag-danger">High</span>';
          default: return '<span class="tag tag-default">None</span>';
        }
      }

      function getPriorityNotificationHeading(type, value){
        switch(type){
          case "None": return '<h6 class="media-heading">' + value + '</h6>';
          case "Low": return '<h6 class="media-heading" style="color:#37BC9B !important;">' + value + '</h6>';
          case "Medium": return '<h6 class="media-heading yellow darken-3">' + value + '</h6>';
          case "High": return '<h6 class="media-heading red darken-1">' + value + '</h6>';
          default: return '<h6 class="media-heading">' + value + '</h6>';
        }
      }

      function getNotificationBlock(notifications){
        return '<li class="list-group scrollable-container ps-container ps-theme-dark ps-active-y">'
                + '<a href="javascript:void(0)" class="list-group-item">'
                + '<div class="media">'
                + '<div class="media-left valign-middle">'
                + getPriorityHtmlBlock(notifications[i].priority)
                + '</div>'
                + '<div class="media-body">'
                + getPriorityNotificationHeading(notifications[i].priority, notifications[i].title)
                + '<p class="notification-text font-small-3 text-muted">' +  notifications[i].description + '</p><small>'
                + '<time class="media-meta text-muted">30 minutes ago</time></small>'
                + '</div>'
                + '</div></a>'
      }

      function replyToRequirement(notification){
        var requirement = getValue(notification.userId, notification.requirementId);
        var html = '<h5><span class="avatar avatar-xs"><img src="app-assets/images/portrait/small/avatar-s-4.png" alt="avatar"></span> ' + notification.username + '</h5>'
                   + '<p>' + notification.description + '</p>'
                  + '<hr>';

        $('#requirment-title').html(requirement.title);

        var comments = '';
        if(typeof requirement.comments !== 'undefined'){
          for (var i=0; i < requirement.comments; i++) {
              comments += createBlock(requirement[i]);
          }
        }
        html = html + comments + '<textarea id="reply-comment-textarea" rows="5" class="form-control square"'
        + ' name="comments" placeholder="reply" userid="' + notification.userId + '" requirementId="' + notification.requirementId + '" ></textarea>';
        $('#requirment-body').html(html);
        openModal('reply-comment-form');
      }

      function saveComment(){
          var comment = $('#reply-comment-textarea').val();
          var user = getUserById($('#reply-comment-textarea').attr('userid'));
          var requirement = getUserRequirementById(user, $('#reply-comment-textarea').attr('requirementId'));
          var comment = {
              id: 0,
              comment: comment,
              userid: currentUser.id,
              username: currentUser.username,
              time: new Date()
          };

          var updatedUser = updateRequirement(user, $('#reply-comment-textarea').attr('requirementId'), comment)
          $.ajax({
              url: "http://localhost:3000/users/" + user.id ,
              type: 'PUT',
              data: JSON.stringify(updatedUser),
              contentType: "application/json",
              success: function(data) {
                window.location = window.location;
              },
            });
      }

      function createBlock(comment){
        return '<h5><span class="avatar avatar-xs"><img src="app-assets/images/portrait/small/avatar-s-4.png" alt="avatar"></span> ' + comment.username + '</h5>'
                   + '<p>' + comment.description + '</p>'
                  + '<hr>';
      }

      function logout(){
        localStorage.removeItem("userSession");
        window.location = window.location.hostname + "/BulletinBoardProject/app/login.html";
      }

      function getValue(userId, requirementId){
          var user = getUserById(userId);
          console.log(getUserRequirementById(user, requirementId));
          return getUserRequirementById(user, requirementId);
      }

      function getUserById(userId){
          for (var i=0; i < userList.length; i++) {
              if (userList[i].id == userId) {
                return  userList[i];
              }
          }
      }

      function getUserRequirementById(user, requirementId){
        for (var i=0; i < user.requirements.length; i++) {
          if (user.requirements[i].id == requirementId) {
              return  user.requirements[i];
          }
        }
      }

      function updateRequirement(user, requirementId, comment){
        for (var i=0; i < user.requirements.length; i++) {
          if (user.requirements[i].id == requirementId) {
            if(typeof user.requirements[i].comments === 'undefined')
            {
              user.requirements[i].comments = [];
              comment.id = 1;
            }
            else
              comment.id = user.requirements[i].comments.length + 1;

           user.requirements[i].comments.push(comment);
          }
        }
        return user;
      }

      var openModal = function(id){
          var elm = document.getElementById(id);
          elm.style.display = "block";
          elm.style.background = "rgba(108, 108, 108, 0.5)";
          elm.classList.add("in");
        };

      var closeModal = function(id){
          var elm = document.getElementById(id);
          elm.style.display = "none";
          elm.classList.remove("in");
        };


    </script>



    <script src="app-assets/vendors/js/ui/tether.min.js" type="text/javascript"></script>
    <script src="app-assets/js/core/libraries/bootstrap.min.js" type="text/javascript"></script>
    <script src="app-assets/vendors/js/ui/perfect-scrollbar.jquery.min.js" type="text/javascript"></script>
    <script src="app-assets/vendors/js/ui/unison.min.js" type="text/javascript"></script>
    <script src="app-assets/vendors/js/ui/blockUI.min.js" type="text/javascript"></script>
    <script src="app-assets/vendors/js/ui/jquery.matchHeight-min.js" type="text/javascript"></script>
    <script src="app-assets/vendors/js/ui/screenfull.min.js" type="text/javascript"></script>
    <script src="app-assets/vendors/js/extensions/pace.min.js" type="text/javascript"></script>
    <!-- BEGIN VENDOR JS-->
    <!-- BEGIN PAGE VENDOR JS-->
    <script src="app-assets/vendors/js/charts/chart.min.js" type="text/javascript"></script>
    <!-- END PAGE VENDOR JS-->
    <!-- BEGIN ROBUST JS-->
    <script src="app-assets/js/core/app-menu.js" type="text/javascript"></script>
    <script src="app-assets/js/core/app.js" type="text/javascript"></script>
    <!-- END ROBUST JS-->
    <!-- BEGIN PAGE LEVEL JS-->
    <script src="app-assets/js/scripts/pages/dashboard-2.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL JS-->
  </body>
</html>
